---
title: "Scorigami!"
subtitle: "Using Markov Chains to Model Unique NFL Game Scores"
author: "Austin Redmond"
date: "3/12/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir = "~/GitHub/ScorigamiMC")
```

# Introduction

#### Project Description and Objectives 

Scorigami is the "art of achieving a final score in an NFL game that has never happened before" (Bois). The final score of an NFL game consists of the total points scored by each of the two teams. Scoring in the NFL All NFL scores are made of 5 different methods of scoring points. THe  (Bois, 7:19)

#### Literature Review

# Methodology

### My Library

```{r My Library, message=FALSE}

library(dplyr, nflscrapR)

multi_scrape_game_ids <- function(seasons, types, weeks = NULL, teams = NULL) {
  library(nflscrapR)
  
  #Schema of the scraped game IDs data frame.
  scrapedGameIDsColNames <- c("type", "game_id", "home_team", "away_team", "week", "season", "state_of_game", "game_url", "home_score", "away_score")
  #Create scraped game IDs data frame with a matching number of columns.
  scrapedGameIDs <- as.data.frame(matrix(,0,length(scrapedGameIDsColNames)))
  #Rename columns of scraped game IDs data frame.
  names(scrapedGameIDs) <- scrapedGameIDsColNames
  
  #Loop for each season and each type of game (which is either preseason, regular season, or postseason).
  for(s in seasons) {
    for(ty in types) {
      #Bind the data scraped so far with the data scraped using the current season, game type, week, and team information.
      scrapedGameIDs <- rbind(scrapedGameIDs, scrape_game_ids(s, ty, weeks = weeks, teams = teams))
    }
  }
  
  #Return the scraped gamed IDs data frame.
  return(scrapedGameIDs)
}

multi_scrape_game_play_by_play <- function(gameIDs) {
  library(nflscrapR)  
  
  #Create an empty list for each game ids' play-by-play data.
  scrapedGamePlayByPlayList = list()
  
  #Loop for each game id.
  for(i in 1:nrow(gameIDs)) {
    #Bind the data scraped so far with the data scraped using the current game id.
    tempScrapedGamePlayByPlay <- scrape_game_play_by_play(gameIDs[i,"game_id"], gameIDs[i,"type"], gameIDs[i,"season"], 0)
    scrapedGamePlayByPlayList[[i]] <- tempScrapedGamePlayByPlay[tempScrapedGamePlayByPlay$quarter_end==1,c("game_id","home_team","away_team","qtr","total_home_score","total_away_score")]
  }
  
  #
  scrapedGamePlayByPlay <- do.call(rbind, scrapedGamePlayByPlayList)
  
  scrapedGamePlayByPlay <- scrapedGamePlayByPlay[complete.cases(scrapedGamePlayByPlay), ]
  
  scrapedGamePlayByPlay <- unique(scrapedGamePlayByPlay)

  return(scrapedGamePlayByPlay)
}

game_data <- function(gameIDs, gamePlayByPlay) {

  n <- length(gameIDs$game_id)
  
  game_id <- gameIDs$game_id
  home_team <- gameIDs$home_team
  away_team <- gameIDs$away_team
  
  qtr1_home_score <- rep(NA, length=n)
  qtr1_away_score <- rep(NA, length=n)
  qtr2_home_score <- rep(NA, length=n)
  qtr2_away_score <- rep(NA, length=n)
  qtr3_home_score <- rep(NA, length=n)
  qtr3_away_score <- rep(NA, length=n)
  qtr4_home_score <- rep(NA, length=n)
  qtr4_away_score <- rep(NA, length=n)
  
  final_home_score <- gameIDs$home_score 
  final_away_score <- gameIDs$away_score
  
  for(i in 1:length(game_id)){
    tryCatch({qtr1_home_score[[i]] <- as.numeric(gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==1,][[1,"total_home_score"]])}, error=function(e){})
    tryCatch({qtr1_away_score[[i]] <- as.numeric(gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==1,][[1,"total_away_score"]])}, error=function(e){})
    tryCatch({qtr2_home_score[[i]] <- as.numeric(gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==2,][[1,"total_home_score"]])}, error=function(e){})
    tryCatch({qtr2_away_score[[i]] <- as.numeric(gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==2,][[1,"total_away_score"]])}, error=function(e){})
    tryCatch({qtr3_home_score[[i]] <- as.numeric(gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==3,][[1,"total_home_score"]])}, error=function(e){})
    tryCatch({qtr3_away_score[[i]] <- as.numeric(gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==3,][[1,"total_away_score"]])}, error=function(e){})
    tryCatch({qtr4_home_score[[i]] <- as.numeric(gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==4,][[1,"total_home_score"]])}, error=function(e){})
    tryCatch({qtr4_away_score[[i]] <- as.numeric(gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==4,][[1,"total_away_score"]])}, error=function(e){})
  }
  
  gameData <- do.call(cbind,list(game_id, home_team, away_team, qtr1_home_score, qtr1_away_score, qtr2_home_score, qtr2_away_score, qtr3_home_score, qtr3_away_score, qtr4_home_score, qtr4_away_score, final_home_score, final_away_score))
  rownames(gameData) <- 1:n
  colnames(gameData) <- c("game_id", "home_team", "away_team", "qtr1_home_score", "qtr1_away_score", "qtr2_home_score", "qtr2_away_score", "qtr3_home_score", "qtr3_away_score", "qtr4_home_score", "qtr4_away_score", "final_home_score", "final_away_score")
  gameData <- as.data.frame(gameData)
  
  return(gameData)
}

points_scored_frequency <- function(gameData){
  
  pointsScoredFrequency <- matrix(rep(0, 32*32), nrow = 32, ncol=32)
  rownames(pointsScoredFrequency) <- 0:31
  colnames(pointsScoredFrequency) <- 0:31
  
  winning_team_scored <- NULL
  losing_team_scored <- NULL
  
  for(i in 1:length(gameData$game_id)){
  
    tryCatch({
      winning_team_scored <- as.character(max(as.numeric(as.character(gameData$qtr1_home_score[i])),as.numeric(as.character(gameData$qtr1_away_score[i]))))
      losing_team_scored <- as.character(min(as.numeric(as.character(gameData$qtr1_home_score[i])),as.numeric(as.character(gameData$qtr1_away_score[i]))))
      pointsScoredFrequency[losing_team_scored,winning_team_scored] <- pointsScoredFrequency[losing_team_scored,winning_team_scored] + 1
    }, error=function(e){})
    
    tryCatch({
      if(as.numeric(as.character(gameData$qtr1_home_score[i]))>as.numeric(as.character(gameData$qtr1_away_score[i]))){
        winning_team_scored <- as.character(as.numeric(as.character(gameData$qtr2_home_score[i])) - as.numeric(as.character(gameData$qtr1_home_score[i])))
        losing_team_scored <- as.character(as.numeric(as.character(gameData$qtr2_away_score[i])) - as.numeric(as.character(gameData$qtr1_away_score[i])))
      } else if(as.numeric(as.character(gameData$qtr1_home_score[i]))<as.numeric(as.character(gameData$qtr1_away_score[i]))) {
        winning_team_scored <- as.character(as.numeric(as.character(gameData$qtr2_away_score[i])) - as.numeric(as.character(gameData$qtr1_away_score[i])))
        losing_team_scored <- as.character(as.numeric(as.character(gameData$qtr2_home_score[i])) - as.numeric(as.character(gameData$qtr1_home_score[i])))
      } else {
        winning_team_scored <- as.character(max(as.numeric(as.character(gameData$qtr2_home_score[i])) - as.numeric(as.character(gameData$qtr1_home_score[i])),
                                                as.numeric(as.character(gameData$qtr2_away_score[i])) - as.numeric(as.character(gameData$qtr1_away_score[i]))))
        losing_team_scored <- as.character(min(as.numeric(as.character(gameData$qtr2_home_score[i])) - as.numeric(as.character(gameData$qtr1_home_score[i])),
                                               as.numeric(as.character(gameData$qtr2_away_score[i])) - as.numeric(as.character(gameData$qtr1_away_score[i]))))
      }
      pointsScoredFrequency[losing_team_scored,winning_team_scored] <- pointsScoredFrequency[losing_team_scored,winning_team_scored] + 1
        
    },error=function(e){})
    
    tryCatch({
      if(as.numeric(as.character(gameData$qtr2_home_score[i]))>as.numeric(as.character(gameData$qtr2_away_score[i]))){
        winning_team_scored <- as.character(as.numeric(as.character(gameData$qtr3_home_score[i])) - as.numeric(as.character(gameData$qtr2_home_score[i])))
        losing_team_scored <- as.character(as.numeric(as.character(gameData$qtr3_away_score[i])) - as.numeric(as.character(gameData$qtr2_away_score[i])))
      } else if(as.numeric(as.character(gameData$qtr2_home_score[i]))<as.numeric(as.character(gameData$qtr2_away_score[i]))) {
        winning_team_scored <- as.character(as.numeric(as.character(gameData$qtr3_away_score[i])) - as.numeric(as.character(gameData$qtr2_away_score[i])))
        losing_team_scored <- as.character(as.numeric(as.character(gameData$qtr3_home_score[i])) - as.numeric(as.character(gameData$qtr2_home_score[i])))
      } else {
        winning_team_scored <- as.character(max(as.numeric(as.character(gameData$qtr3_home_score[i])) - as.numeric(as.character(gameData$qtr2_home_score[i])),
                                                as.numeric(as.character(gameData$qtr3_away_score[i])) - as.numeric(as.character(gameData$qtr2_away_score[i]))))
        losing_team_scored <- as.character(min(as.numeric(as.character(gameData$qtr3_home_score[i])) - as.numeric(as.character(gameData$qtr2_home_score[i])),
                                               as.numeric(as.character(gameData$qtr3_away_score[i])) - as.numeric(as.character(gameData$qtr2_away_score[i]))))
      }
      pointsScoredFrequency[losing_team_scored,winning_team_scored] <- pointsScoredFrequency[losing_team_scored,winning_team_scored] + 1
        
    },error=function(e){})
    
    tryCatch({
      if(as.numeric(as.character(gameData$qtr3_home_score[i]))>as.numeric(as.character(gameData$qtr3_away_score[i]))){
        winning_team_scored <- as.character(as.numeric(as.character(gameData$qtr4_home_score[i])) - as.numeric(as.character(gameData$qtr3_home_score[i])))
        losing_team_scored <- as.character(as.numeric(as.character(gameData$qtr4_away_score[i])) - as.numeric(as.character(gameData$qtr3_away_score[i])))
      } else if(as.numeric(as.character(gameData$qtr3_home_score[i]))<as.numeric(as.character(gameData$qtr3_away_score[i]))) {
        winning_team_scored <- as.character(as.numeric(as.character(gameData$qtr4_away_score[i])) - as.numeric(as.character(gameData$qtr3_away_score[i])))
        losing_team_scored <- as.character(as.numeric(as.character(gameData$qtr4_home_score[i])) - as.numeric(as.character(gameData$qtr3_home_score[i])))
      } else {
        winning_team_scored <- as.character(max(as.numeric(as.character(gameData$qtr4_home_score[i])) - as.numeric(as.character(gameData$qtr3_home_score[i])),
                                                as.numeric(as.character(gameData$qtr4_away_score[i])) - as.numeric(as.character(gameData$qtr3_away_score[i]))))
        losing_team_scored <- as.character(min(as.numeric(as.character(gameData$qtr4_home_score[i])) - as.numeric(as.character(gameData$qtr3_home_score[i])),
                                               as.numeric(as.character(gameData$qtr4_away_score[i])) - as.numeric(as.character(gameData$qtr3_away_score[i]))))
      }
      pointsScoredFrequency[losing_team_scored,winning_team_scored] <- pointsScoredFrequency[losing_team_scored,winning_team_scored] + 1
        
    },error=function(e){})
  }
  
  return(pointsScoredFrequency)
  
}

points_scored_observations <- function(pointsScoredFrequency) {
  
  pointsScoredObservations <- list()

  for(c in as.character(0:31)) {
    for(r in as.character(0:31)) {
      n <- pointsScoredFrequency[r,c]
      temp <- list()
      tryCatch({
        temp <- list()
        for (i in 1:n) {
          temp[[i]] <- c(as.numeric(as.character(r)), as.numeric(as.character(c)))
        }
        pointsScoredObservations <- append(pointsScoredObservations, temp)
      },error=function(e){})
    }
  }
  
  pointsScoredObservations <- do.call(rbind, pointsScoredObservations)
  colnames(pointsScoredObservations) <- c("losing_team_points_scored","winning_team_points_scored")
  
  pointsScoredObservations <- as.data.frame(pointsScoredObservations)
  
  return(pointsScoredObservations)
}

combined_points_scored_frequency <- function(pointsScoredObservations) {
  
  combinedPointsScoredObservations <- c(pointsScoredObservations$losing_team_points_scored, pointsScoredObservations$winning_team_points_scored)
  #combinedFrequency <- vector(mode="numeric", length = max(combinedPointsScoredObservations) + 1)
  combinedFrequency <- matrix(rep(0, 32), nrow = 32, ncol=1)
  
  for(i in 1:length(combinedPointsScoredObservations)) {
    combinedFrequency[[combinedPointsScoredObservations[i]+1]] <- combinedFrequency[[combinedPointsScoredObservations[i]+1]] + 1
  }
  
  rownames(combinedFrequency) <- as.character(0:max(combinedPointsScoredObservations))
  colnames(combinedFrequency) <- c("combined_team_points_scored")
  
  return(combinedFrequency)
}

```


### Data Scraping

#### Install nflscrapR

nflscrapR is an R package that is used to "utilize and analyze data from the National Football League (NFL) API". It is necessary to install it in order to scrape data pertaining to NFL box scores. The nflscrapR package can be found at https://github.com/maksimhorowitz/nflscrapR. The devtools package can install R packages hosted on Github.
  
```{r Installation of nflscrapR, message=FALSE}

library(devtools)

#Install nflscrapR from Github using devtools.
devtools::install_github(repo = "maksimhorowitz/nflscrapR")

```

#### Scrape Game IDs

```{r Scrape Game IDS, message=FALSE, cache=TRUE}

#Scrape all regular and post season game ids from 2009 to 2018.
#scrapedGameIDs <- multi_scrape_game_ids(2009:2018, c("reg", "post"))
load("scrapedGameIDs.Rda")


#Display the first six observations.
head(select(scrapedGameIDs, -c("game_url", "state_of_game")))

#Save scraped game ids to file.
save(scrapedGameIDs, file = "scrapedGameIDs.Rda")

```

#### Scrape Game Play-by-Play

```{r Scape Game Play-by-Play, message=FALSE, cache=TRUE}

#Load the scraped game ids data frame from file.
load("scrapedGameIDs.Rda")

#Scrape play-by-play data of all selected games.
#scrapedGamePlayByPlay <- multi_scrape_game_play_by_play(scrapedGameIDs)

load("scrapedGamePlayByPlay.Rda")

#Display the first six observations.
head(scrapedGamePlayByPlay)

#Save scraped game play-by-play data to file.
save(scrapedGamePlayByPlay, file = "scrapedGamePlayByPlay.Rda")

```

#### Combine Data Sets

```{r Combine Data Sets}

#Load both scraped datasets.
load("scrapedGameIDs.Rda")
load("scrapedGamePlayByPlay.Rda")

gameData <- game_data(scrapedGameIDs, scrapedGamePlayByPlay)
head(gameData)

save(gameData, file = "gameData.Rda")


```

### The Markov Chain Representation

#### Get Transition Data (Points Scored by Each Team for Each Quarter)

```{r, Construct the Distribution, error=FALSE}
load("gameData.Rda")

pointsScoredFrequency <- points_scored_frequency(gameData)

save(pointsScoredFrequency, file="pointsScoredFrequency.Rda")
 
pointsScoredObservations <- points_scored_observations(pointsScoredFrequency)

save(pointsScoredObservations, file="pointsScoredObservations.Rda")

library(plot.matrix, viridis)

x <- pointsScoredFrequency
x[x==0] <- NA
plot(x, breaks=c(0,1,2,3,5,9,14,50,100,150,1000),col = magma, main="Points Scored Frequency Matrix", xlab = "Winning Team Points Scored in One Quarter", ylab = "Losing Team Points Scored in One Quarter")

library(ggplot2)

ggplot() + 
  geom_histogram(aes(x = pointsScoredObservations$losing_team_points_scored, fill = "r"), alpha = 0.3, bins = 31) +
  geom_histogram(aes(x = pointsScoredObservations$winning_team_points_scored, fill = "b"), alpha = 0.3, bins = 31) +
  scale_colour_manual(name ="Histograms of Points Scored", values = c("r" = "red", "b" = "blue"), labels=c("b" = "Winning Team", "r" = "Losing Team")) +
  scale_fill_manual(name ="Legend", values = c("r" = "red", "b" = "blue"), labels=c("b" = "Winning Team", "r" = "Winning"))+
  labs(title = "Histograms of Points Scored", x = "Points Scored", y = "Frequency")

ks.test(pointsScoredObservations$losing_team_points_scored, pointsScoredObservations$winning_team_points_scored)

combinedPointsScoredFrequency <- combined_points_scored_frequency(pointsScoredObservations)

ggplot()+
  geom_histogram(aes(x=c(pointsScoredObservations$losing_team_points_scored, pointsScoredObservations$winning_team_points_scored)), bins = 31)+
  labs(title = "Histogram of Points Scored by All Teams", x = "Points Scored", y = "Frequency")

pointsScoredRelativeFrequency <- pointsScoredFrequency / sum(pointsScoredFrequency)

winningTeamPointsScoredRelativeFrequency <- colSums(pointsScoredFrequency) / sum(pointsScoredFrequency)

losingTeamPointsSCoredRelativeFrequency <- rowSums(pointsScoredFrequency) / sum(pointsScoredFrequency)

combinedPointsScoredRelativeFrequency <- combinedPointsScoredFrequency / sum(pointsScoredFrequency)


```

#### Possible States

```{r Possible States}

load("pointsScoredObservations.Rda")

states <- c("0-0")

for(w in 1:(max(pointsScoredObservations$winning_team_points_scored) * 4)) {
  for(l in 0:(w - 1)) {
    states[[length(states)+1]] <- paste(w,l, sep ="-")
  }
}

states <- states[(states != "1-0") & (states != "1-1") & (states != "2-1") & (states != "3-1") & (states != "4-1") & (states != "5-1") & (states != "7-1")]

length(states)

View(states)

```

#### Transiton Matrix

```{r}



```



# Works Cited

Bois, John. "Every NFL Score Ever | Chart Party". *Youtube*, SB Nation, December 7, 2016, https://www.youtube.com/watch?v=9l5C8cGMueY.

Horowitz, Marksim. "Introducing the nflscrapR Package." Github, https://github.com/maksimhorowitz/nflscrapR. Accessesd 15 November 2019.

https://seahawkswire.usatoday.com/2018/12/03/seahawks-continue-bizarre-scorigami-streak-under-pete-carroll/

```{r Testing}
  gameIDs <- scrapedGameIDs
  gamePlayByPlay <- scrapedGamePlayByPlay
  #All game data will have one observation for each game.
  n <- length(gameIDs$game_id)
  
  game_id <- gameIDs$game_id
  home_team <- gameIDs$home_team
  away_team <- gameIDs$away_team
  
  qtr1_home_score <- rep(NA, length=n)
  qtr1_away_score <- rep(NA, length=n)
  qtr2_home_score <- rep(NA, length=n)
  qtr2_away_score <- rep(NA, length=n)
  qtr3_home_score <- rep(NA, length=n)
  qtr3_away_score <- rep(NA, length=n)
  qtr4_home_score <- rep(NA, length=n)
  qtr4_away_score <- rep(NA, length=n)
  final_home_score <- gameIDs$home_score 
  final_away_score <- gameIDs$away_score
  
  for(i in 1:length(game_id)){
    tryCatch({qtr1_home_score[[i]] <- gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==1,][[1,"total_home_score"]]}, error=function(e){})
    tryCatch({qtr1_away_score[[i]] <- gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==1,][[1,"total_away_score"]]}, error=function(e){})
    tryCatch({qtr2_home_score[[i]] <- gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==2,][[1,"total_home_score"]]}, error=function(e){})
    tryCatch({qtr2_away_score[[i]] <- gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==2,][[1,"total_away_score"]]}, error=function(e){})
    tryCatch({qtr3_home_score[[i]] <- gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==3,][[1,"total_home_score"]]}, error=function(e){})
    tryCatch({qtr3_away_score[[i]] <- gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==3,][[1,"total_away_score"]]}, error=function(e){})
    tryCatch({qtr4_home_score[[i]] <- gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==4,][[1,"total_home_score"]]}, error=function(e){})
    tryCatch({qtr4_away_score[[i]] <- gamePlayByPlay[gamePlayByPlay$game_id==game_id[i]&gamePlayByPlay$qtr==4,][[1,"total_away_score"]]}, error=function(e){})
  }
  
  gameData <- do.call(cbind,list(game_id, home_team, away_team, qtr1_home_score, qtr1_away_score, qtr2_home_score, qtr2_away_score, qtr3_home_score, qtr3_away_score, qtr4_home_score, qtr4_away_score, final_home_score, final_away_score))
  rownames(gameData) <- 1:n
  colnames(gameData) <- c("game_id", "home_team", "away_team", "qtr1_home_score", "qtr1_away_score", "qtr2_home_score", "qtr2_away_score", "qtr3_home_score", "qtr3_away_score", "qtr4_home_score", "qtr4_away_score", "final_home_score", "final_away_score")
  
  dim(gameData[complete.cases(gameData),])

```

